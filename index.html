<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Performance Dashboard</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f8fafc;
      color: #111827;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #2563eb;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .tab-container {
      display: flex;
      justify-content: space-around;
      background-color: #e5e7eb;
      padding: 0.5rem;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      cursor: pointer;
      font-weight: 500;
    }
    .tab.active {
      background-color: #2563eb;
      color: white;
      border-radius: 0.5rem;
    }
    .section {
      display: none;
      padding: 1.5rem;
    }
    .section.active {
      display: block;
    }
    .hidden {
      display: none;
    }
    .loader {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      justify-content: center;
      align-items: center;
      font-size: 1.25rem;
      color: #2563eb;
      font-weight: bold;
      z-index: 1000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #2563eb;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sales Performance Dashboard</h1>
    <p>Welcome, <span id="currentUser">Loading...</span></p>
  </header>

  <div class="tab-container">
    <div class="tab active" data-target="dashboardSection">Dashboard</div>
    <div class="tab" data-target="goalsSection">Goals</div>
    <div class="tab" data-target="teamSection">Team View</div>
    <div class="tab admin-tab hidden" data-target="adminSection">Admin</div>
  </div>

  <div id="app">
    <div id="dashboardSection" class="section active">
      <h2>My Weekly Summary</h2>
      <div id="dashboardData">Loading dashboard data...</div>
    </div>

    <div id="goalsSection" class="section">
      <h2>My Goals</h2>
      <div id="goalsData">Loading goals...</div>
    </div>

    <div id="teamSection" class="section">
      <h2>Team View</h2>
      <div id="teamData">Loading team data...</div>
    </div>

    <div id="adminSection" class="section hidden">
      <h2>Admin Panel</h2>
      <h3>Staff List</h3>
      <table>
        <thead>
          <tr><th>Name</th><th>Email</th><th>Role</th></tr>
        </thead>
        <tbody id="staffListTable"></tbody>
      </table>

      <h3>Weekly Team Performance</h3>
      <table>
        <thead>
          <tr><th>Name</th><th>Dials</th><th>Presentations</th><th>Binds</th><th>ALP</th></tr>
        </thead>
        <tbody id="adminDashboardTable"></tbody>
      </table>
    </div>
  </div>

  <div class="loader" id="loader">Loading...</div>

  <script>
    // 🌍 BACKEND API LINK (Replace this with your deployed Apps Script URL)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";

    // 🔐 USER SESSION MANAGEMENT
    function getUserEmail() {
      let userEmail = localStorage.getItem("userEmail");
      if (!userEmail) {
        userEmail = prompt("Please enter your email address to continue:");
        if (userEmail) localStorage.setItem("userEmail", userEmail);
      }
      return userEmail || "anonymous@unknown.com";
    }

    // 🌐 UNIVERSAL API CALLER
    async function callApi(action, payload = {}, method = "POST") {
      const userEmail = getUserEmail();
      const loader = document.getElementById("loader");
      loader.style.display = "flex";

      try {
        let response;
        if (method === "GET") {
          const url = new URL(APPS_SCRIPT_URL);
          url.searchParams.append("action", action);
          url.searchParams.append("email", userEmail);
          response = await fetch(url);
        } else {
          response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, payload, email: userEmail }),
          });
        }

        const result = await response.json();
        if (!result.success) throw new Error(result.message || "API call failed");
        return result;
      } catch (error) {
        console.error(`API Error (${action}):`, error);
        alert(`Error: ${error.message}`);
        throw error;
      } finally {
        loader.style.display = "none";
      }
    }

    // 🚀 INITIALIZATION
    async function initializeApp() {
      try {
        const { data: user } = await callApi("getUserInfo", {}, "GET");
        document.getElementById("currentUser").textContent = user.name || "Guest User";

        if (user.isAdmin) {
          document.querySelector(".admin-tab").classList.remove("hidden");
          loadAdminData();
        }

        setupTabs();
        await Promise.all([loadDashboard(), loadGoals(), loadTeamData()]);
      } catch (error) {
        document.getElementById("currentUser").textContent = "Not Logged In";
      }
    }

    // 🧭 TAB NAVIGATION
    function setupTabs() {
      const tabs = document.querySelectorAll(".tab");
      const sections = document.querySelectorAll(".section");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          sections.forEach((s) => s.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById(tab.dataset.target).classList.add("active");
        });
      });
    }

    // 📊 LOAD DASHBOARD
    async function loadDashboard() {
      const { data } = await callApi("getDashboardData", {}, "GET");
      const div = document.getElementById("dashboardData");
      div.innerHTML = `
        <p><strong>Dials:</strong> ${data.personal.dials}</p>
        <p><strong>Presentations:</strong> ${data.personal.presentations}</p>
        <p><strong>Binds:</strong> ${data.personal.binds}</p>
        <p><strong>ALP:</strong> $${data.personal.alp.toFixed(2)}</p>
      `;
    }

    // 🎯 LOAD GOALS
    async function loadGoals() {
      const { data } = await callApi("getGoals", {}, "GET");
      const div = document.getElementById("goalsData");
      const { goals, progress } = data;
      div.innerHTML = `
        <h3>Monthly Goals</h3>
        <p>Dials: ${progress.dials}/${goals.dials}</p>
        <p>Presentations: ${progress.presentations}/${goals.presentations}</p>
        <p>Binds: ${progress.binds}/${goals.binds}</p>
        <p>ALP: $${progress.alp.toFixed(2)}/$${goals.alp}</p>
      `;
    }

    // 👥 LOAD TEAM VIEW
    async function loadTeamData() {
      const { data } = await callApi("getTeamViewData", {}, "GET");
      const div = document.getElementById("teamData");
      div.innerHTML = data.map(member => `
        <p><strong>${member.name}</strong> — Dials: ${member.dials}, Pres: ${member.presentations}, ALP: $${member.alp.toFixed(2)}</p>
      `).join("");
    }

    // 🧩 ADMIN PANEL
    async function loadAdminData() {
      const [{ data: staffList }, { data: adminData }] = await Promise.all([
        callApi("getStaffList", {}, "GET"),
        callApi("getAdminDashboardData", {}, "GET")
      ]);

      document.getElementById("staffListTable").innerHTML = staffList
        .map(staff => `<tr><td>${staff.Name}</td><td>${staff.Email}</td><td>${staff.Role}</td></tr>`)
        .join("");

      document.getElementById("adminDashboardTable").innerHTML = adminData
        .map(staff => `<tr><td>${staff.name}</td><td>${staff.dials}</td><td>${staff.presentations}</td><td>${staff.binds}</td><td>$${staff.alp.toFixed(2)}</td></tr>`)
        .join("");
    }

    window.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</body>
</html>
